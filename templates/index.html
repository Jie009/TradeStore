<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>交易记录</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="nav">
      <div class="nav-inner">
        <div class="brand">交易记录</div>
        <button class="hamburger" id="nav-toggle" aria-label="menu">☰</button>
        <nav id="nav-links">
          <a href="/" class="active">现货</a>
          <a href="/bots">合约机器人</a>
          <a href="/assets">总资产</a>
          <a href="/calc">计算器</a>
        </nav>
      </div>
    </header>
    <main class="container">
      <section class="card">
        <h2>新增现货交易</h2>
        <form id="spot-form">
          <div class="grid">
            <label
              >币种
              <div style="display: flex; gap: 8px; align-items: center">
                <select id="symbol-select" name="symbol"></select>
                <input id="symbol-input" placeholder="新增币种 如 BTCUSDT" />
                <button type="button" id="add-symbol">添加</button>
              </div>
            </label>
            <label
              >方向
              <select name="side">
                <option>BUY</option>
                <option>SELL</option>
              </select>
            </label>

            <label>
              输入方式
              <select id="amount-mode">
                <option value="quantity">按成交量</option>
                <option value="amount">成交额</option>
              </select>
            </label>

            <label id="quantity-wrap"
              >成交量
              <input name="quantity" type="number" step="0.0000001" />
            </label>
            <label id="amount-wrap" style="display: none"
              >成交额(计价币)
              <input name="amount_quote" type="number" step="0.0000001" />
            </label>

            <label
              >价格 <input name="price" type="number" step="0.0000001" required
            /></label>

            <label>
              手续费模式
              <select name="fee_mode" id="fee-mode">
                <option value="taker">taker(0.1%)</option>
                <option value="maker">maker(0.1%)</option>
                <option value="custom">自定义</option>
              </select>
            </label>
            <label id="fee-wrap" style="display: none"
              >手续费（自动/自定义）
              <input name="fee" type="number" step="0.0000001" />
            </label>

            <label>时间 <input name="traded_at" type="datetime-local" /></label>
          </div>
          <label>备注 <input name="note" /></label>
          <button type="submit">保存</button>
        </form>
      </section>

      <section class="card">
        <h2>现货汇总</h2>
        <div id="spot-summary"></div>
      </section>

      <section class="card">
        <h2>现货记录</h2>
        <div id="spot-trades"></div>
      </section>
    </main>

    <script>
      document.getElementById("nav-toggle").addEventListener("click", () => {
        document.getElementById("nav-links").classList.toggle("open");
      });

      function toggleFee() {
        const mode = document.getElementById("fee-mode").value;
        document.getElementById("fee-wrap").style.display =
          mode === "custom" ? "" : "none";
      }
      document.getElementById("fee-mode").addEventListener("change", toggleFee);

      function toggleAmountMode() {
        const mode = document.getElementById("amount-mode").value;
        document.getElementById("quantity-wrap").style.display =
          mode === "quantity" ? "" : "none";
        document.getElementById("amount-wrap").style.display =
          mode === "amount" ? "" : "none";
      }
      document
        .getElementById("amount-mode")
        .addEventListener("change", toggleAmountMode);

      async function loadSymbols() {
        try {
          const res = await fetch("/api/symbols");
          if (!res.ok) throw new Error("加载币种失败");
          const list = await res.json();
          const sel = document.getElementById("symbol-select");
          sel.innerHTML = "";
          for (const s of list) {
            const opt = document.createElement("option");
            opt.value = s.symbol;
            opt.textContent = s.symbol;
            sel.appendChild(opt);
          }
          if (sel.options.length > 0) {
            sel.selectedIndex = 0;
          }
        } catch (e) {
          console.error(e);
        }
      }

      document
        .getElementById("add-symbol")
        .addEventListener("click", async () => {
          const val = (
            document.getElementById("symbol-input").value || ""
          ).trim();
          if (!val) return;
          try {
            const res = await fetch("/api/symbols", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ symbol: val }),
            });
            if (!res.ok) {
              const t = await res.text();
              alert("添加币种失败：" + t);
              return;
            }
            document.getElementById("symbol-input").value = "";
            await loadSymbols();
            document.getElementById("symbol-select").value = val.toUpperCase();
          } catch (e) {
            alert("网络错误：" + e.message);
          }
        });

      async function deleteTrade(id) {
        if (!confirm("确定删除这条记录吗？")) return;
        const res = await fetch(`/api/spot_trades/${id}`, { method: "DELETE" });
        if (!res.ok) {
          const t = await res.text();
          alert("删除失败：" + t);
          return;
        }
        await refreshTrades();
        await refreshSummary();
      }

      async function refreshTrades() {
        try {
          const res = await fetch("/api/spot_trades");
          if (!res.ok) throw new Error("加载记录失败");
          const data = await res.json();

          // 按时间排序并计算每行的毛利率和成本价
          const sortedData = data.sort((a, b) => new Date(a.traded_at) - new Date(b.traded_at));

          // 维护每个币种的状态
          const symbolStates = {};

          const rows = sortedData.map((r) => {
            const symbol = r.symbol;
            if (!symbolStates[symbol]) {
              symbolStates[symbol] = {
                quantity: 0,
                lastBuyPrice: 0,
                totalGrossProfit: 0,
                costBasisTotal: 0
              };
            }

            const state = symbolStates[symbol];
            const fee = r.fee || 0;
            const feeCurrency = (r.fee_currency || "quote").toLowerCase();

            let grossProfit = 0;
            let costPrice = 0;

            if (r.side.toUpperCase() === 'BUY') {
              // 更新最近买价
              state.lastBuyPrice = r.price;

              // 更新持仓
              if (feeCurrency === 'base') {
                const netQty = Math.max(0, r.quantity - fee);
                const totalQuote = r.quantity * r.price;
                state.quantity += netQty;
                state.costBasisTotal += totalQuote;
              } else {
                const totalQuote = r.quantity * r.price + fee;
                state.quantity += r.quantity;
                state.costBasisTotal += totalQuote;
              }

              // 买入时毛利率为0
              grossProfit = 0;
            } else {
              // 卖出时计算毛利率
              grossProfit = (r.price - state.lastBuyPrice) * r.quantity;
              state.totalGrossProfit += grossProfit;

              // 更新持仓
              const avgCost = state.quantity > 0 ? state.costBasisTotal / state.quantity : 0;
              state.quantity -= r.quantity;
              if (state.quantity < 0) {
                state.quantity = 0;
                state.costBasisTotal = 0;
              } else {
                state.costBasisTotal -= avgCost * r.quantity;
              }
            }

            // 计算成本价
            const sourcePrice = state.quantity * state.lastBuyPrice;
            costPrice = state.quantity > 0 ? (sourcePrice - state.totalGrossProfit) / state.quantity : 0;

            return `
            <tr class="${r.side.toUpperCase() === 'BUY' ? 'trade-buy' : 'trade-sell'}">
              <td>${new Date(r.traded_at).toLocaleString()}</td>
              <td>${r.symbol}</td>
              <td>${r.side}</td>
              <td>${r.quantity.toFixed(7)}</td>
              <td>${r.price.toFixed(7)}</td>
              <td>${grossProfit.toFixed(2)}</td>
              <td>${costPrice.toFixed(7)}</td>
              <td>${r.fee.toFixed(7)} (${r.fee_currency})</td>
              <td>${r.note || ""}</td>
              <td><button class=\"btn-danger\" onclick=\"deleteTrade(${r.id})\">删除</button></td>
            </tr>
          `;
          }).join("");

          document.getElementById("spot-trades").innerHTML = `
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>时间</th><th>币种</th><th>方向</th><th>成交量</th><th>价格</th><th>毛利率</th><th>成本价</th><th>手续费</th><th>备注</th><th></th></tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
        } catch (e) {
          console.error(e);
        }
      }

      async function refreshSummary() {
        try {
          const res = await fetch("/api/summary/spot");
          if (!res.ok) throw new Error("加载汇总失败");
          const data = await res.json();
          const rows = data.symbols
            .map(
              (s) => `
			<tr>
				<td>${s.symbol}</td>
				<td>${s.position_quantity.toFixed(7)}</td>
				<td>${s.last_buy_price.toFixed(7)}</td>
				<td>${s.source_price.toFixed(2)}</td>
				<td>${s.total_gross_profit.toFixed(2)}</td>
				<td>${s.cost_price.toFixed(7)}</td>
				<td>${s.realized_pnl.toFixed(2)}</td>
				<td>${s.last_trade_at ? new Date(s.last_trade_at).toLocaleString() : ""}</td>
			</tr>`
            )
            .join("");
          document.getElementById("spot-summary").innerHTML = `
            <div class="table-wrap">
              <table class="compact">
                <thead>
                  <tr>
                    <th>币种</th>
                    <th>持仓数量</th>
                    <th>最近买价</th>
                    <th>源头价</th>
                    <th>总毛利率</th>
                    <th>成本价</th>
                    <th>已实现盈亏</th>
                    <th>最近交易</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
                <tfoot>
                  <tr>
                    <td>合计</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${data.total_realized_pnl.toFixed(2)}</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>`;
        } catch (e) {
          console.error(e);
        }
      }

      function setDefaultTimeNow() {
        const input = document.querySelector('input[name="traded_at"]');
        if (!input) return;
        if (!input.value) {
          const now = new Date();
          const tzoffset = now.getTimezoneOffset() * 60000;
          const localISO = new Date(now - tzoffset).toISOString().slice(0, 16);
          input.value = localISO;
        }
      }

      document
        .getElementById("spot-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = e.currentTarget;
          const symbol = document.getElementById("symbol-select").value;
          const side = form.querySelector('[name="side"]').value;
          const price = parseFloat(
            form.querySelector('[name="price"]').value || "0"
          );
          const mode = document.getElementById("amount-mode").value;
          const feeMode = document.getElementById("fee-mode").value;
          const note = form.querySelector('[name="note"]').value || "";
          const tradedAt = form.querySelector('[name="traded_at"]').value;

          let quantity = null;
          let amount_quote = null;
          if (mode === "amount") {
            const amt = form.querySelector('[name="amount_quote"]').value;
            amount_quote = amt ? parseFloat(amt) : null;
          } else {
            const qty = form.querySelector('[name="quantity"]').value;
            quantity = qty ? parseFloat(qty) : null;
          }

          let fee = null;
          if (feeMode === "custom") {
            const f = form.querySelector('[name="fee"]').value;
            fee = f ? parseFloat(f) : null;
          }

          const payload = {
            symbol,
            side,
            quantity,
            amount_quote,
            price,
            fee,
            traded_at: tradedAt ? new Date(tradedAt).toISOString() : null,
            note,
          };

          try {
            const res = await fetch("/api/spot_trades", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              const t = await res.text();
              alert("保存失败：" + t);
              return;
            }
            // 清空部分输入，刷新列表
            form.querySelector('[name="quantity"]').value = "";
            form.querySelector('[name="amount_quote"]').value = "";
            form.querySelector('[name="fee"]').value = "";
            // 价格和时间通常保留，方便连续输入
            await refreshTrades();
            await refreshSummary();
          } catch (err) {
            alert("网络错误：" + err.message);
          }
        });

      toggleAmountMode();
      toggleFee();
      loadSymbols();
      refreshSummary();
      refreshTrades();
      setDefaultTimeNow();
    </script>
  </body>
</html>
